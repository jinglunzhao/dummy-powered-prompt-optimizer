<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TRUE GEPA Optimization Results - AI Dummy Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .generation-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .generation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .prompt-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .prompt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .performance-metric {
            font-size: 1.2em;
            font-weight: bold;
        }
        .improvement-positive { color: #28a745; }
        .improvement-negative { color: #dc3545; }
        .improvement-neutral { color: #6c757d; }
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        .generation-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .chart-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>AI Dummy Analysis Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link active" href="/optimization">
                    <i class="fas fa-chart-line me-1"></i>TRUE GEPA Results
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Header -->
        <div class="generation-header text-center">
            <h2><i class="fas fa-brain me-2"></i>TRUE GEPA Evolution Dashboard</h2>
            <p class="mb-0">5 Generations of Evolutionary Prompt Optimization</p>
            <p class="mb-0">AI Dummies • Test Runs • Component Discovery</p>
        </div>

        <!-- Experiment Selection -->
        <div class="row mb-4">
            <div class="col-md-8 mx-auto">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-flask me-2"></i>Select GEPA Experiment</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <select id="experiment-select" class="form-select">
                                    <option value="">Loading experiments...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button id="load-experiment-btn" class="btn btn-success w-100" disabled>
                                    <i class="fas fa-play me-2"></i>Load Experiment
                                </button>
                            </div>
                        </div>
                        <div id="experiment-info" class="mt-3" style="display: none;">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="experiment-details"></span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Best Results Chart -->
        <div class="chart-container">
            <h5 class="text-center mb-3"><i class="fas fa-chart-line me-2"></i>Best Performance by Generation</h5>
            <canvas id="generationChart" width="400" height="200"></canvas>
        </div>

        <!-- Generations Overview -->
        <div class="row" id="generationsContainer">
            <div class="loading">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Loading generations...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load optimization results on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadExperimentList();
            // Auto-load the first experiment after list is loaded
        });

        // Experiment selection functionality
        function loadExperimentList() {
            fetch('/api/gepa_experiments')
                .then(response => response.json())
                .then(experiments => {
                    const select = document.getElementById('experiment-select');
                    select.innerHTML = '<option value="">Select a GEPA experiment...</option>';
                    
                    experiments.forEach(exp => {
                        const option = document.createElement('option');
                        option.value = exp.filename;
                        option.textContent = `${exp.name} (${exp.date})`;
                        select.appendChild(option);
                    });
                    
                    if (experiments.length > 0) {
                        // Auto-select and load the first (most recent) experiment
                        select.value = experiments[0].filename;
                        updateExperimentInfo(experiments[0]);
                        document.getElementById('load-experiment-btn').disabled = false;
                        // Auto-load the first experiment
                        loadSelectedExperiment();
                    }
                })
                .catch(error => {
                    console.error('Error loading experiment list:', error);
                    document.getElementById('experiment-select').innerHTML = 
                        '<option value="">Error loading experiments</option>';
                });
        }

        function updateExperimentInfo(experiment) {
            const details = document.getElementById('experiment-details');
            const info = document.getElementById('experiment-info');
            
            details.textContent = `${experiment.test_name} • ${experiment.dummies_count} dummies • ${experiment.conversation_rounds} rounds • ${experiment.generations} generations`;
            info.style.display = 'block';
        }

        // Store currently loaded experiment globally
        let currentExperimentFile = null;
        
        function loadSelectedExperiment() {
            const select = document.getElementById('experiment-select');
            const filename = select.value;
            
            if (!filename) {
                alert('Please select an experiment to load.');
                return;
            }
            
            // Store for later use
            currentExperimentFile = filename;
            
            // Show loading state
            document.getElementById('generationsContainer').innerHTML = `
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                    <p>Loading experiment data...</p>
                </div>
            `;
            
            fetch(`/api/gepa_experiment/${filename}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Update the page title with experiment info
                    const expInfo = data.test_config || {};
                    document.querySelector('.generation-header h2').innerHTML = 
                        `<i class="fas fa-brain me-2"></i>GEPA Experiment: ${expInfo.test_name || 'Unknown'}`;
                    document.querySelector('.generation-header p').textContent = 
                        `${expInfo.dummies_count || '?'} Dummies • ${expInfo.conversation_rounds || '?'} Rounds • ${expInfo.generations || '?'} Generations`;
                    
                    // Display the optimization data
                    const optimizationData = data.optimization || data;
                    displayGenerationsOverview(optimizationData);
                    initializeGenerationChart(optimizationData);
                })
                .catch(error => {
                    console.error('Error loading experiment:', error);
                    document.getElementById('generationsContainer').innerHTML = 
                        '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading experiment data: ' + error.message + '</div>';
                });
        }

        // Event listeners
        document.getElementById('experiment-select').addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            const loadBtn = document.getElementById('load-experiment-btn');
            
            if (this.value) {
                loadBtn.disabled = false;
                // You could add experiment info display here if needed
            } else {
                loadBtn.disabled = true;
                document.getElementById('experiment-info').style.display = 'none';
            }
        });

        document.getElementById('load-experiment-btn').addEventListener('click', loadSelectedExperiment);

        function loadOptimizationResults() {
            fetch('/api/optimization')
                .then(response => response.json())
                .then(data => {
                    displayGenerationsOverview(data);
                    initializeGenerationChart(data);
                })
                .catch(error => {
                    console.error('Error loading optimization results:', error);
                    document.getElementById('generationsContainer').innerHTML = 
                        '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading optimization results</div>';
                });
        }

        function displayGenerationsOverview(data) {
            const container = document.getElementById('generationsContainer');
            
            // Add toggle buttons for different views
            const toggleHtml = `
                <div class="row mb-4">
                    <div class="col-12 text-center">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" onclick="switchView('generations')">
                                <i class="fas fa-layer-group me-2"></i>Evolutionary Process
                            </button>
                            <button type="button" class="btn btn-outline-success" onclick="switchView('pareto')">
                                <i class="fas fa-trophy me-2"></i>Pareto Frontier (7 Solutions)
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Use all_prompts to show total count per generation, then group by generation
            const displayData = data.all_prompts || data.best_per_generation || data.pareto_frontier;
            
            if (!data || !displayData || displayData.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center text-muted">
                        <i class="fas fa-info-circle fa-3x mb-3"></i>
                        <h5>No optimization results available</h5>
                        <p>Run the TRUE GEPA optimization test to see results here.</p>
                        <a href="/" class="btn btn-primary">Back to Dashboard</a>
                    </div>
                `;
                return;
            }

            // Group prompts by generation
            const generations = {};
            displayData.forEach(prompt => {
                const gen = prompt.generation || 0;
                if (!generations[gen]) {
                    generations[gen] = [];
                }
                generations[gen].push(prompt);
            });

            let html = toggleHtml;
            
            // Create generation cards
            Object.keys(generations).sort((a, b) => parseInt(a) - parseInt(b)).forEach(genNum => {
                const genPrompts = generations[genNum];
                const bestPrompt = genPrompts.reduce((best, current) => {
                    const bestScore = (best.performance_metrics?.avg_improvement || 0);
                    const currentScore = (current.performance_metrics?.avg_improvement || 0);
                    return currentScore > bestScore ? current : best;
                });

                const avgImprovement = bestPrompt.performance_metrics?.avg_improvement || 0;
                const totalPrompts = genPrompts.length;

                html += `
                    <div class="col-lg-4 col-md-6 mb-4">
                        <div class="card generation-card h-100" onclick="viewGeneration(${genNum})">
                            <div class="card-header text-center bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-layer-group me-2"></i>Generation ${genNum}</h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="performance-metric improvement-positive mb-3">
                                    +${avgImprovement.toFixed(2)} points
                                </div>

                                <div class="mb-3">
                                    <strong>Prompts:</strong> ${totalPrompts}
                                </div>
                                <div class="mb-3">
                                    <strong>Dummies Tested:</strong> ${bestPrompt.performance_metrics?.test_count || 0}
                                </div>
                                <button class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-eye me-1"></i>View Details
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }
        
        function switchView(viewType) {
            const container = document.getElementById('generationsContainer');
            
            if (viewType === 'pareto') {
                // Show Pareto frontier solutions
                fetch('/api/optimization')
                    .then(response => response.json())
                    .then(data => {
                        const paretoData = data.pareto_frontier || [];
                        
                        if (paretoData.length === 0) {
                            container.innerHTML = `
                                <div class="col-12 text-center text-muted">
                                    <i class="fas fa-trophy fa-3x mb-3"></i>
                                    <h5>No Pareto frontier solutions available</h5>
                                    <p>These represent the 7 non-dominated solutions across all generations.</p>
                                </div>
                            `;
                            return;
                        }
                        
                        let html = `
                            <div class="row mb-4">
                                <div class="col-12 text-center">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary" onclick="switchView('generations')">
                                            <i class="fas fa-layer-group me-2"></i>Evolutionary Process
                                        </button>
                                        <button type="button" class="btn btn-outline-success active" onclick="switchView('pareto')">
                                            <i class="fas fa-trophy me-2"></i>Pareto Frontier (${paretoData.length} Solutions)
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Pareto Frontier:</strong> These ${paretoData.length} solutions are non-dominated across all 20 assessment criteria. 
                                        Each represents a different optimization strategy for social skills training.
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        paretoData.forEach((prompt, index) => {
                            const avgImprovement = prompt.performance_metrics?.avg_improvement || 0;
                            
                            html += `
                                <div class="col-lg-6 col-md-12 mb-4">
                                    <div class="card prompt-card h-100" onclick="viewPrompt('${prompt.id}')">
                                        <div class="card-header text-center bg-success text-white">
                                            <h6 class="mb-0"><i class="fas fa-trophy me-2"></i>Pareto Solution ${index + 1}</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <strong>Name:</strong> ${prompt.name}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Generation:</strong> ${prompt.generation}
                                            </div>
                                            <div class="mb-3">
                                                <strong>Prompt:</strong><br>
                                                <small class="text-muted">${prompt.prompt_text}</small>
                                            </div>
                                            <div class="row text-center">
                                                <div class="col-12">
                                                    <div class="performance-metric improvement-positive">
                                                        +${avgImprovement.toFixed(2)}
                                                    </div>
                                                    <small>Avg Improvement</small>
                                                </div>
                                            </div>
                                            <div class="text-center mt-3">
                                                <button class="btn btn-outline-success btn-sm" onclick="viewPromptDetails('${prompt.id}')">
                                                    <i class="fas fa-eye me-1"></i>View ${prompt.performance_metrics?.test_count || 0} Dummy Results
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        container.innerHTML = html;
                    });
            } else {
                // Show evolutionary process (default view)
                loadOptimizationResults();
            }
        }

        function initializeGenerationChart(data) {
            // Use best_per_generation for chart display
            const displayData = data.all_prompts || data.best_per_generation || data.pareto_frontier;
            if (!displayData || displayData.length === 0) return;

            const ctx = document.getElementById('generationChart');
            if (!ctx) return;
            
            // Destroy existing chart if it exists
            if (window.generationChartInstance) {
                window.generationChartInstance.destroy();
                window.generationChartInstance = null;
            }

            // Group by generation and find best performance
            const generations = {};
            displayData.forEach(prompt => {
                const gen = prompt.generation || 0;
                if (!generations[gen]) {
                    generations[gen] = [];
                }
                generations[gen].push(prompt);
            });

            const labels = Object.keys(generations).sort((a, b) => parseInt(a) - parseInt(b));
            const improvements = labels.map(gen => {
                const genPrompts = generations[gen];
                const bestPrompt = genPrompts.reduce((best, current) => {
                    const bestScore = (best.performance_metrics?.avg_improvement || 0);
                    const currentScore = (current.performance_metrics?.avg_improvement || 0);
                    return currentScore > bestScore ? current : best;
                });
                return bestPrompt.performance_metrics?.avg_improvement || 0;
            });

            window.generationChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels.map(gen => `Generation ${gen}`),
                    datasets: [{
                        label: 'Best Improvement (points)',
                        data: improvements,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 3,
                        pointBackgroundColor: '#28a745',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Performance Evolution Across Generations'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Improvement (points)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Generation'
                            }
                        }
                    }
                }
            });
        }

        function viewGeneration(generationNum) {
            // Pass the current experiment file as a query parameter
            if (currentExperimentFile) {
                window.location.href = `/generation/${generationNum}?experiment=${encodeURIComponent(currentExperimentFile)}`;
            } else {
                window.location.href = `/generation/${generationNum}`;
            }
        }

        function viewPromptDetails(promptId) {
            window.location.href = `/prompt/${promptId}`;
        }
    </script>
</body>
</html>