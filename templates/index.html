<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Dummy Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dummy-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .dummy-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .personality-badge {
            font-size: 0.8em;
            margin: 2px;
        }
        .score-display {
            font-size: 1.2em;
            font-weight: bold;
        }
        .improvement-positive { color: #28a745; }
        .improvement-negative { color: #dc3545; }
        .improvement-neutral { color: #6c757d; }
        .conversation-turn {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 8px;
        }
        .dummy-turn {
            background-color: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .ai-turn {
            background-color: #e7f3ff;
            border-left: 4px solid #28a745;
        }
        .assessment-question {
            margin-bottom: 10px;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        
        /* Family Tree Styles */
        .family-tree-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 600px;
            padding: 20px;
            border-radius: 10px;
        }
        
        .tree-header {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .controls {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 5px 15px;
            border: 1px solid #17a2b8;
            background: white;
            color: #17a2b8;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .filter-btn.active {
            background: #17a2b8;
            color: white;
        }
        
        .filter-btn:hover {
            background: #17a2b8;
            color: white;
        }
        
        #tree-svg {
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin: 20px 0;
        }
        
        .node {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .node:hover {
            transform: scale(1.05);
        }
        
        .node.genesis {
            fill: #28a745;
        }
        
        .node.mutation {
            fill: #ffc107;
        }
        
        .node.crossover {
            fill: #dc3545;
        }
        
        .node.elite {
            fill: #6f42c1;
        }
        
        .node-text {
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: bold;
            text-anchor: middle;
            pointer-events: none;
            fill: white;
        }
        
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }
        
        .link.mutation {
            stroke: #ffc107;
            stroke-width: 3px;
        }
        
        .link.crossover {
            stroke: #dc3545;
            stroke-width: 3px;
        }
        
        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            max-width: 300px;
        }
        
        .synthesis-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: none;
        }
        
        .synthesis-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 20px;
            border-radius: 10px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-robot me-2"></i>AI Dummy Analysis Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Dashboard
                </a>
                <a class="nav-link" href="/optimization">
                    <i class="fas fa-chart-line me-1"></i>TRUE GEPA Results
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Tab Navigation -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <ul class="nav nav-tabs card-header-tabs" id="dashboardTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                                    <i class="fas fa-chart-bar me-2"></i>Overview
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="family-tree-tab" data-bs-toggle="tab" data-bs-target="#family-tree" type="button" role="tab">
                                    <i class="fas fa-sitemap me-2"></i>Prompt Family Tree
                                </button>
                            </li>
                        </ul>
                    </div>
                    <div class="card-body">
                        <div class="tab-content" id="dashboardTabContent">
                            <!-- Overview Tab -->
                            <div class="tab-pane fade show active" id="overview" role="tabpanel">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h4><i class="fas fa-chart-bar me-2"></i>Overview Statistics</h4>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-md-3">
                                                        <div class="border rounded p-3">
                                                            <h3 class="text-primary">{{ total_dummies }}</h3>
                                                            <p class="mb-0">Total Dummies</p>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="border rounded p-3">
                                                            <h3 class="text-success">{{ total_assessments }}</h3>
                                                            <p class="mb-0">Total Assessments</p>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="border rounded p-3">
                                                            <h3 class="text-info">{{ total_conversations }}</h3>
                                                            <p class="mb-0">Total Conversations</p>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="border rounded p-3">
                                                            <h3 class="text-warning">{{ complete_pairs }}</h3>
                                                            <p class="mb-0">Complete Pairs</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row mt-4">
                                    <div class="col-12">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h4><i class="fas fa-users me-2"></i>AI Dummies</h4>
                                                <div class="input-group" style="max-width: 300px;">
                                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                                    <input type="text" class="form-control" id="searchInput" placeholder="Search dummies...">
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div id="dummiesContainer" class="row">
                                                    <div class="loading">
                                                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                                        <p>Loading dummies...</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Family Tree Tab -->
                            <div class="tab-pane fade" id="family-tree" role="tabpanel">
                                <div id="familyTreeContent">
                                    <div class="loading">
                                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                                        <p>Loading family tree...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <script>
        // Load dummies on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadDummies();
        });

        // Search functionality
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filterDummies(searchTerm);
        });

        function loadDummies() {
            fetch('/api/dummies')
                .then(response => response.json())
                .then(dummies => {
                    console.log('Loaded dummies:', dummies);
                    if (dummies.length > 0) {
                        console.log('First dummy structure:', dummies[0]);
                    }
                    displayDummies(dummies);
                })
                .catch(error => {
                    console.error('Error loading dummies:', error);
                    document.getElementById('dummiesContainer').innerHTML = 
                        '<div class="col-12 text-center text-danger">Error loading dummies: ' + error.message + '</div>';
                });
        }

        function displayDummies(dummies) {
            const container = document.getElementById('dummiesContainer');
            
            if (dummies.length === 0) {
                container.innerHTML = '<div class="col-12 text-center">No dummies found</div>';
                return;
            }

            const html = dummies.map(dummy => {
                // Calculate anxiety category from the anxiety level
                const anxietyLevel = dummy.social_anxiety?.anxiety_level || 0;
                const anxietyCategory = getAnxietyCategory(anxietyLevel);
                const anxietyColor = getAnxietyColor(anxietyLevel);
                
                return `
                    <div class="col-lg-4 col-md-6 mb-4 dummy-item" data-name="${dummy.name?.toLowerCase() || ''}" data-gender="${dummy.gender?.toLowerCase() || ''}" data-age="${dummy.age || 0}">
                        <div class="card dummy-card h-100" onclick="viewDummy('${dummy.id || ''}')">
                            <div class="card-header text-center">
                                <h5 class="mb-0">${dummy.name || 'Unknown'}</h5>
                                <small class="text-muted">${dummy.gender || 'Unknown'}, ${dummy.age || 0} years old</small>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <strong>Anxiety Level:</strong> ${anxietyLevel}/10
                                    <span class="badge bg-${anxietyColor} ms-2">
                                        ${anxietyCategory}
                                    </span>
                                </div>
                                <div class="mb-3">
                                    <strong>Personality:</strong><br>
                                    <span class="badge bg-primary personality-badge">E: ${dummy.personality?.extraversion || 0}</span>
                                    <span class="badge bg-success personality-badge">A: ${dummy.personality?.agreeableness || 0}</span>
                                    <span class="badge bg-info personality-badge">C: ${dummy.personality?.conscientiousness || 0}</span>
                                    <span class="badge bg-warning personality-badge">N: ${dummy.personality?.neuroticism || 0}</span>
                                    <span class="badge bg-secondary personality-badge">O: ${dummy.personality?.openness || 0}</span>
                                </div>
                                <div class="text-center">
                                    <button class="btn btn-primary btn-sm">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function getAnxietyCategory(level) {
            if (level <= 3) return 'Low';
            if (level <= 6) return 'Moderate';
            return 'High';
        }

        function getAnxietyColor(level) {
            if (level <= 3) return 'success';
            if (level <= 6) return 'warning';
            return 'danger';
        }

        function filterDummies(searchTerm) {
            const dummyItems = document.querySelectorAll('.dummy-item');
            
            dummyItems.forEach(item => {
                const name = item.dataset.name;
                const gender = item.dataset.gender;
                const age = item.dataset.age;
                
                if (name.includes(searchTerm) || gender.includes(searchTerm) || age.toString().includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function viewDummy(dummyId) {
            window.location.href = `/dummy/${dummyId}`;
        }

        // Family Tree Variables
        let allPrompts = [];
        let filteredPrompts = [];
        let svg, g, tooltip;
        let width, height;
        let familyTreeLoaded = false;

        // Tab event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listener for family tree tab
            const familyTreeTab = document.getElementById('family-tree-tab');
            if (familyTreeTab) {
                familyTreeTab.addEventListener('shown.bs.tab', function() {
                    if (!familyTreeLoaded) {
                        loadFamilyTree();
                        familyTreeLoaded = true;
                    }
                });
            }
        });

        function loadFamilyTree() {
            const container = document.getElementById('familyTreeContent');
            
            // Create family tree HTML structure
            container.innerHTML = `
                <div class="family-tree-container">
                    <!-- Header -->
                    <div class="tree-header">
                        <h1><i class="fas fa-sitemap me-2"></i>GEPA Prompt Family Tree</h1>
                        <p class="mb-0">Evolution visualization showing prompt relationships and synthesis analysis</p>
                    </div>
                    
                    <!-- Controls -->
                    <div class="controls">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Filter by Generation:</h6>
                                <div class="filter-buttons" id="generationFilters">
                                    <button class="filter-btn active" data-generation="all">All</button>
                                    <button class="filter-btn" data-generation="0">G0</button>
                                    <button class="filter-btn" data-generation="1">G1</button>
                                    <button class="filter-btn" data-generation="2">G2</button>
                                    <button class="filter-btn" data-generation="3">G3</button>
                                    <button class="filter-btn" data-generation="4">G4</button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Filter by Type:</h6>
                                <div class="filter-buttons" id="typeFilters">
                                    <button class="filter-btn active" data-type="all">All</button>
                                    <button class="filter-btn" data-type="genesis">Genesis</button>
                                    <button class="filter-btn" data-type="mutation">Mutations</button>
                                    <button class="filter-btn" data-type="crossover">Crossovers</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading -->
                    <div id="loading" class="loading">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Loading prompt family tree...</p>
                    </div>
                    
                    <!-- Family Tree SVG -->
                    <div id="familyTree" style="display: none;">
                        <svg id="tree-svg" width="100%" height="800"></svg>
                    </div>
                    
                    <!-- Tooltip -->
                    <div id="tooltip" class="tooltip"></div>
                    
                    <!-- Synthesis Modal -->
                    <div id="synthesisModal" class="synthesis-modal">
                        <div class="synthesis-content">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5>Synthesis Analysis</h5>
                                <button type="button" class="btn-close" onclick="closeSynthesisModal()"></button>
                            </div>
                            <div id="synthesisContent">
                                Loading synthesis analysis...
                            </div>
                        </div>
                    </div>
                </div>
            `;

            // Load family tree data
            loadFamilyTreeData();
        }

        function loadFamilyTreeData() {
            fetch('/api/family-tree')
                .then(response => response.json())
                .then(data => {
                    allPrompts = data.prompts || [];
                    filteredPrompts = [...allPrompts];
                    initializeTree();
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('familyTree').style.display = 'block';
                    setupFilters();
                })
                .catch(error => {
                    console.error('Error loading family tree data:', error);
                    document.getElementById('loading').innerHTML = 
                        '<div class="text-center text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Error loading data</div>';
                });
        }

        function setupFilters() {
            // Generation filters
            document.querySelectorAll('#generationFilters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#generationFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilters();
                });
            });
            
            // Type filters
            document.querySelectorAll('#typeFilters .filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('#typeFilters .filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilters();
                });
            });
        }

        function applyFilters() {
            const selectedGeneration = document.querySelector('#generationFilters .filter-btn.active').dataset.generation;
            const selectedType = document.querySelector('#typeFilters .filter-btn.active').dataset.type;
            
            filteredPrompts = allPrompts.filter(prompt => {
                const genMatch = selectedGeneration === 'all' || prompt.generation == selectedGeneration;
                const typeMatch = selectedType === 'all' || getPromptType(prompt) === selectedType;
                return genMatch && typeMatch;
            });
            
            displayTree();
        }

        function getPromptType(prompt) {
            if (prompt.generation === 0) return 'genesis';
            if (prompt.name.includes('M')) return 'mutation';
            if (prompt.name.includes('C')) return 'crossover';
            if (prompt.name.includes('E')) return 'elite';
            return 'genesis';
        }

        function initializeTree() {
            // Get container dimensions with proper fallback
            const container = document.getElementById('tree-svg').parentElement;
            width = Math.max(container.offsetWidth - 40, 800); // Minimum width of 800
            height = 800;
            
            // Create SVG
            svg = d3.select('#tree-svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create main group
            g = svg.append('g');
            
            // Create tooltip
            tooltip = d3.select('#tooltip');
            
            displayTree();
        }

        function displayTree() {
            if (!svg) {
                console.error('SVG not initialized');
                return;
            }
            
            // Check if D3 is loaded
            if (typeof d3 === 'undefined') {
                g.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .text('D3.js failed to load. Please refresh the page.');
                return;
            }
            
            // Clear previous tree
            g.selectAll('*').remove();
            
            // Build tree data structure
            const treeData = buildTreeData();
            
            if (treeData.length === 0) {
                g.append('text')
                    .attr('x', width / 2)
                    .attr('y', height / 2)
                    .attr('text-anchor', 'middle')
                    .text('No prompts found for selected filters');
                return;
            }
            
            // Create tree layout with proper dimensions
            const treeWidth = Math.max(width - 100, 700);
            const treeHeight = Math.max(height - 100, 600);
            
            const tree = d3.tree()
                .size([treeWidth, treeHeight]);
            
            const root = d3.hierarchy(treeData[0]);
            tree(root);
            
            // Add links
            g.selectAll('.link')
                .data(root.links())
                .enter().append('path')
                .attr('class', d => `link ${getLinkType(d.target.data)}`)
                .attr('d', d3.linkVertical()
                    .x(d => d.x + 50)
                    .y(d => d.y + 50))
                .style('fill', 'none');
            
            // Add nodes
            const node = g.selectAll('.node')
                .data(root.descendants())
                .enter().append('g')
                .attr('class', d => `node ${getPromptType(d.data)}`)
                .attr('transform', d => `translate(${d.x + 50}, ${d.y + 50})`)
                .on('click', d => showSynthesis(d.data))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip);
            
            // Add circles
            node.append('circle')
                .attr('r', 20);
            
            // Add text
            node.append('text')
                .attr('class', 'node-text')
                .attr('dy', 5)
                .text(d => d.data.name.length > 15 ? d.data.name.substring(0, 15) + '...' : d.data.name);
        }

        function buildTreeData() {
            // Find root nodes (generation 0)
            const roots = filteredPrompts.filter(p => p.generation === 0);
            
            if (roots.length === 0) return [];
            
            // Build tree structure recursively
            function buildNode(prompt) {
                const node = {
                    id: prompt.id,
                    name: prompt.name,
                    generation: prompt.generation,
                    type: getPromptType(prompt),
                    performance: prompt.performance_metrics || {},
                    prompt_text: prompt.prompt_text || '',
                    children: []
                };
                
                // Find children (prompts that have this prompt as parent)
                // For old data without parent_names, use name matching
                const children = filteredPrompts.filter(p => {
                    if (p.generation === prompt.generation + 1) {
                        // If parent_names exists, use it
                        if (p.parent_names && p.parent_names.length > 0) {
                            return p.parent_names.includes(prompt.name);
                        }
                        // Otherwise, try to match by name pattern (for old data)
                        return p.name.includes(prompt.name) || 
                               (prompt.name !== 'Genesis' && p.name.includes('from_' + prompt.name));
                    }
                    return false;
                });
                
                children.forEach(child => {
                    node.children.push(buildNode(child));
                });
                
                return node;
            }
            
            return roots.map(buildNode);
        }

        function getLinkType(nodeData) {
            return nodeData.type || 'genesis';
        }

        function showTooltip(event, d) {
            const performance = d.data.performance || {};
            const avgImprovement = performance.avg_improvement || 0;
            const testCount = performance.test_count || 0;
            const promptText = d.data.prompt_text || 'No prompt text available';
            
            tooltip
                .style('opacity', 1)
                .html(`
                    <strong>${d.data.name}</strong><br/>
                    Generation: ${d.data.generation}<br/>
                    Type: ${d.data.type}<br/>
                    Improvement: +${avgImprovement.toFixed(3)}<br/>
                    Tests: ${testCount}<br/>
                    <hr style="margin: 5px 0;">
                    <strong>Prompt Text:</strong><br/>
                    <small>${promptText.length > 200 ? promptText.substring(0, 200) + '...' : promptText}</small>
                `)
                .style('left', (event.pageX + 10) + 'px')
                .style('top', (event.pageY - 10) + 'px');
        }

        function hideTooltip() {
            tooltip.style('opacity', 0);
        }

        function showSynthesis(promptData) {
            const modal = document.getElementById('synthesisModal');
            const content = document.getElementById('synthesisContent');
            
            content.innerHTML = 'Loading synthesis analysis...';
            modal.style.display = 'block';
            
            fetch(`/api/prompt/${promptData.id}/synthesis`)
                .then(response => response.json())
                .then(data => {
                    content.innerHTML = `
                        <h6>${promptData.name} (G${promptData.generation})</h6>
                        <div class="mb-3">
                            <strong>Parent(s):</strong> ${(data.parent_names || []).join(', ') || 'None (Genesis)'}
                        </div>
                        <div class="mb-3">
                            <strong>Prompt Text:</strong>
                            <div class="mt-2 p-3 bg-light rounded">${promptData.prompt_text || 'No prompt text available'}</div>
                        </div>
                        <div class="mb-3">
                            <strong>Synthesis Analysis:</strong>
                            <div class="mt-2 p-3 bg-light rounded">${data.synthesis_analysis || 'No synthesis analysis available'}</div>
                        </div>
                        <div class="text-muted">
                            <small>Based on ${data.conversation_count || 0} conversations</small>
                        </div>
                    `;
                })
                .catch(error => {
                    content.innerHTML = `
                        <h6>${promptData.name} (G${promptData.generation})</h6>
                        <div class="mb-3">
                            <strong>Prompt Text:</strong>
                            <div class="mt-2 p-3 bg-light rounded">${promptData.prompt_text || 'No prompt text available'}</div>
                        </div>
                        <div class="text-muted">No synthesis analysis available</div>
                    `;
                });
        }

        function closeSynthesisModal() {
            document.getElementById('synthesisModal').style.display = 'none';
        }
    </script>
</body>
</html>